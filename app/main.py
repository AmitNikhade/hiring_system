
test_form = ["""""

Section 1: Introductory Questions Instructions: Please provide brief responses.

1.1. How would you describe yourself in three words?

Learning constantly, knowledge application, innovation

1.2. What motivated you to apply for this position?

Interaction with various dept

1.3. Share a situation where you had to overcome a significant challenge. How did you handle it?

Working in night shifts and handling 100 work power on shop floor

Section 2: Personality Traits Instructions: Rate the following statements on a scale of 1 to 5, where 1 is strongly disagree and 5 is strongly agree.

2.1. I am comfortable working in a team. - 4

2.2. I enjoy taking on new challenges. - 5

2.3. I am detail-oriented. - 4

2.4. I can handle stress well. - 4

2.5. I am adaptable to change.- 5

Section 3: Work Ethic and Values Instructions: Choose the response that best describes your approach.

3.1. When facing a tight deadline, I am more likely to: a) Prioritize quality over speed b) Prioritize speed over perfection - a.

3.2. How do you handle disagreements with colleagues? a) Confront the issue directly b) Seek compromise and find common ground - b.

3.3. Describe your approach to time management and meeting deadlines.

Time management should be valued and optimally used to meet deadlines in a effective way

Section 4: Problem-Solving Skills Instructions: Provide detailed responses.

4.1. Share an example of a work-related problem you successfully solved. What steps did you take?

SOP Implementation. Activities are assigned and explained to respective persons to align them for smooth working.

4.2. How do you approach situations where you don’t have all the information needed to make a decision?

Gather information and take time to make a decision based on intuition.

Section 5: Interpersonal Skills Instructions: Choose the response that best represents your behavior.

5.1. In a group setting, I am more likely to: a) Take a leadership role b) Listen and contribute ideas as a team member - b

5.2. How do you build rapport with colleagues and clients?

Understand their working style and requirements and engage accordingly as per the need

Section 6: Communication Skills Instructions: Rate your proficiency on a scale of 1 to 5, where 1 is not proficient and 5 is highly proficient.

6.1. Written communication skills: 4

6.2. Verbal communication skills: 4

Section 7: Situational Judgment Instructions: Choose the response that best aligns with your approach.

7.1. You discover a mistake in a project that could have serious consequences. What do you do? a) Immediately report it to your supervisor b) Try to fix it yourself before reporting - a/b depending on the situation and shift

7.2. How do you handle criticism and feedback?

Constructively

Section 8: Additional Information Instructions: Provide any additional information you believe is relevant to your application.

8.1. Are there any specific achievements or experiences that you feel make you a strong fit for this position?

Similar role during my previous consultancy experience

8.2. Is there anything else you would like us to know about you?

Chill and relaxed

Thank you for completing the personality and character analysis test. We appreciate your time and effort.


2) How will you describe yourself in a paragraph?
[Text Input of at least 300 words, that completely describe]


My name is Shreyas Harish Kale, age - 28 yrs young. My native place is Panchgani which is a hill station in the Western Ghats. We are 4 members in our family - Mother, Father, younger Brother. I come from a middle class family background, which helps me to be simple and adapt as per the situation. I am quite shy, and take time to open up. But as time progresses, the time taken to build a bond catalyses it to be strong and builds a lifelong bond with family, people, friends, etc.


I am an introvert and intuitive person. People very close (family and my childhood friends) to me know my nature which generally does not reflect in my body language. I was good at studies, so I chose to become an Engineer. Also I like playing sports a lot from my school days. Sports helps to be neutral and keeps a balance in life. Hence, though my nature is soft spoken and mild, but it's aggressive from inside in a good way just like a Fast Bowler in Cricket. My interests are mixed - both education and sports, trekking and trips to different places.


I like to chat with people regarding their life, struggles, success and more importantly failure. It helps to know a person more deeply about their mindset, nature other than just knowing them socially and casually. My aim is to buy a house for my family in the coming months/a year or so and stay with them happily and build a career along with the aspirations and gain stability.






3) Employee Strengths and Weaknesses Analysis Test

Instructions:

    Answer each question honestly and to the best of your ability.

    There is no time limit, but please complete the test in one sitting.

    Your responses will be confidential and used only for evaluation purposes.

Section 1: Skills Assessment

1.1. Rate your proficiency (1 = novice, 5 = expert) in the following skills:

    Project management: 3.5

    Data analysis: 4

    Written communication: 4

    Technical skills relevant to the position: 4

Section 2: Behavioral Questions

2.1. Describe a challenging situation at work where you demonstrated problem-solving skills. What was the outcome?

SOP Implementation. Activities are assigned and explained to respective persons to align them for smooth working.

2.2. How do you handle tight deadlines and high-pressure situations?

Calmly

2.3. Provide an example of a successful collaboration with a team. What role did you play?

Projects in Internship. Intern

Project at JSAW - Business Analyst - IE

Section 3: Self-Reflection

3.1. What do you consider your greatest professional achievement, and why?

AIR - 6 in the UN exam in secondary section.

Successful SOP implementation in Manufacturing Industry and playing a small part in it.

3.2. Identify a skill or area where you feel you can improve. What steps are you taking to address this?

Be vocal. Talking - Communication on a regular basis

Multiple thoughts. Streamline thoughts at a particular time as per the need of the hour

Section 4: Scenario-Based Questions

4.1. You receive conflicting instructions from two supervisors regarding task priorities. How do you handle this situation?

Common grounds solution

4.2. If you were assigned a project outside your comfort zone, how would you approach it?

Do my homework before approaching

Section 5: Situational Judgment

5.1. In a team project, a team member is not contributing adequately. How would you address this issue?

Explain the roles and responsibilities and help them whenever needed

5.2. You discover a mistake in a report just before a deadline. What steps do you take?

Correct the mistake within the deadline. If not, accept the mistake

Section 6: Job-Specific Knowledge

6.1. Demonstrate your understanding of key concepts related to [specific area relevant to the job].

Logically understand the key steps involved and diagram it as per process

6.2. How do you stay updated on industry trends and advancements?

Reading, notifications, websites

Section 7: Open-Ended Questions

7.1. Share your long-term career goals and how this position aligns with them.

Long - term career goals - GM in 10-15 yrs

Aligns with understanding the roles and responsibilities of individuals, SWOT analysis and plug the gaps and loopholes

7.2. What attracted you to our organization, and how do you see yourself contributing to our mission?

Working with MSMEs will be a new and helpful experience.

Contribute - customer satisfaction by applying our mission"""""],["""""Personal Information:

    Full Name: SHREYAS HARISH KALE

    Position Applied For: SR ASSOCIATE - INDUSTRIAL ENGINEER

    Date: 16/01/24

Section 1: Introductory Questions Instructions: Please provide brief responses.

1.1. How would you describe yourself in three words?

Learning constantly, knowledge application, innovation

1.2. What motivated you to apply for this position?

Interaction with various dept

1.3. Share a situation where you had to overcome a significant challenge. How did you handle it?

Working in night shifts and handling 100 work power on shop floor

Section 2: Personality Traits Instructions: Rate the following statements on a scale of 1 to 5, where 1 is strongly disagree and 5 is strongly agree.

2.1. I am comfortable working in a team. - 4

2.2. I enjoy taking on new challenges. - 5

2.3. I am detail-oriented. - 4

2.4. I can handle stress well. - 4

2.5. I am adaptable to change.- 5

Section 3: Work Ethic and Values Instructions: Choose the response that best describes your approach.

3.1. When facing a tight deadline, I am more likely to: a) Prioritize quality over speed b) Prioritize speed over perfection - a.

3.2. How do you handle disagreements with colleagues? a) Confront the issue directly b) Seek compromise and find common ground - b.

3.3. Describe your approach to time management and meeting deadlines.

Time management should be valued and optimally used to meet deadlines in a effective way

Section 4: Problem-Solving Skills Instructions: Provide detailed responses.

4.1. Share an example of a work-related problem you successfully solved. What steps did you take?

SOP Implementation. Activities are assigned and explained to respective persons to align them for smooth working.

4.2. How do you approach situations where you don’t have all the information needed to make a decision?

Gather information and take time to make a decision based on intuition.

Section 5: Interpersonal Skills Instructions: Choose the response that best represents your behavior.

5.1. In a group setting, I am more likely to: a) Take a leadership role b) Listen and contribute ideas as a team member - b

5.2. How do you build rapport with colleagues and clients?

Understand their working style and requirements and engage accordingly as per the need

Section 6: Communication Skills Instructions: Rate your proficiency on a scale of 1 to 5, where 1 is not proficient and 5 is highly proficient.

6.1. Written communication skills: 4

6.2. Verbal communication skills: 4

Section 7: Situational Judgment Instructions: Choose the response that best aligns with your approach.

7.1. You discover a mistake in a project that could have serious consequences. What do you do? a) Immediately report it to your supervisor b) Try to fix it yourself before reporting - a/b depending on the situation and shift

7.2. How do you handle criticism and feedback?

Constructively

Section 8: Additional Information Instructions: Provide any additional information you believe is relevant to your application.

8.1. Are there any specific achievements or experiences that you feel make you a strong fit for this position?

Similar role during my previous consultancy experience

8.2. Is there anything else you would like us to know about you?

Chill and relaxed

Thank you for completing the personality and character analysis test. We appreciate your time and effort.


2) How will you describe yourself in a paragraph?
[Text Input of at least 300 words, that completely describe]


My name is Shreyas Harish Kale, age - 28 yrs young. My native place is Panchgani which is a hill station in the Western Ghats. We are 4 members in our family - Mother, Father, younger Brother. I come from a middle class family background, which helps me to be simple and adapt as per the situation. I am quite shy, and take time to open up. But as time progresses, the time taken to build a bond catalyses it to be strong and builds a lifelong bond with family, people, friends, etc.


I am an introvert and intuitive person. People very close (family and my childhood friends) to me know my nature which generally does not reflect in my body language. I was good at studies, so I chose to become an Engineer. Also I like playing sports a lot from my school days. Sports helps to be neutral and keeps a balance in life. Hence, though my nature is soft spoken and mild, but it's aggressive from inside in a good way just like a Fast Bowler in Cricket. My interests are mixed - both education and sports, trekking and trips to different places.


I like to chat with people regarding their life, struggles, success and more importantly failure. It helps to know a person more deeply about their mindset, nature other than just knowing them socially and casually. My aim is to buy a house for my family in the coming months/a year or so and stay with them happily and build a career along with the aspirations and gain stability.






3) Employee Strengths and Weaknesses Analysis Test

Instructions:

    Answer each question honestly and to the best of your ability.

    There is no time limit, but please complete the test in one sitting.

    Your responses will be confidential and used only for evaluation purposes.

Section 1: Skills Assessment

1.1. Rate your proficiency (1 = novice, 5 = expert) in the following skills:

    Project management: 3.5

    Data analysis: 4

    Written communication: 4

    Technical skills relevant to the position: 4

Section 2: Behavioral Questions

2.1. Describe a challenging situation at work where you demonstrated problem-solving skills. What was the outcome?

SOP Implementation. Activities are assigned and explained to respective persons to align them for smooth working.

2.2. How do you handle tight deadlines and high-pressure situations?

Calmly

2.3. Provide an example of a successful collaboration with a team. What role did you play?

Projects in Internship. Intern

Project at JSAW - Business Analyst - IE

Section 3: Self-Reflection

3.1. What do you consider your greatest professional achievement, and why?

AIR - 6 in the UN exam in secondary section.

Successful SOP implementation in Manufacturing Industry and playing a small part in it.

3.2. Identify a skill or area where you feel you can improve. What steps are you taking to address this?

Be vocal. Talking - Communication on a regular basis

Multiple thoughts. Streamline thoughts at a particular time as per the need of the hour

Section 4: Scenario-Based Questions

4.1. You receive conflicting instructions from two supervisors regarding task priorities. How do you handle this situation?

Common grounds solution

4.2. If you were assigned a project outside your comfort zone, how would you approach it?

Do my homework before approaching

Section 5: Situational Judgment

5.1. In a team project, a team member is not contributing adequately. How would you address this issue?

Explain the roles and responsibilities and help them whenever needed

5.2. You discover a mistake in a report just before a deadline. What steps do you take?

Correct the mistake within the deadline. If not, accept the mistake

Section 6: Job-Specific Knowledge

6.1. Demonstrate your understanding of key concepts related to [specific area relevant to the job].

Logically understand the key steps involved and diagram it as per process

6.2. How do you stay updated on industry trends and advancements?

Reading, notifications, websites

Section 7: Open-Ended Questions

7.1. Share your long-term career goals and how this position aligns with them.

Long - term career goals - GM in 10-15 yrs

Aligns with understanding the roles and responsibilities of individuals, SWOT analysis and plug the gaps and loopholes

7.2. What attracted you to our organization, and how do you see yourself contributing to our mission?

Working with MSMEs will be a new and helpful experience.

Contribute - customer satisfaction by applying our mission"""""]




import os
from google.cloud import storage
import pandas as pd

directory_name = "text_files"


try:
    os.mkdir(directory_name)
    print(f"Directory '{directory_name}' created successfully.")
except FileExistsError:
    print(f"Directory '{directory_name}' already exists.")
except Exception as e:
    print(f"An error occurred: {e}")

#/home/amitn/.config/gcloud/application_default_credentials.json
# credential_path = "/home/amitn/Documents/hiring_system/app/axonaai-9f40bfe31ab5.json"
# os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = credential_path
# os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "/home/amitn/Documents/hiring_system/app/axonaai-9f40bfe31ab5.json"

def download_csv_from_gcp_bucket():
    """Download a CSV file from a Google Cloud Storage bucket."""
    bucket_name = "axona-hs1"
    file_name = "jd/jtjp.csv"
    destination_path = "text_files/jtjp.csv"  # Full destination path including file name

    # Initialize a client
    storage_client = storage.Client()

    # Get the bucket
    bucket = storage_client.get_bucket(bucket_name)

    # Get the blob (file) from the bucket
    blob = bucket.blob(file_name)

    # Download the blob to the specified destination path
    blob.download_to_filename(destination_path)

    print(f"Downloaded {file_name} to {destination_path}")






def create_csv():
    # Create an empty DataFrame with columns 'jt' and 'jsd'
    df = pd.DataFrame(columns=['jt', 'jd'])

    # Save the empty DataFrame as a temporary CSV file
    df.to_csv('jtjp.csv', index=False)

    # Instantiate a GCS client
    client = storage.Client()

    # Set the bucket name
    bucket_name = "axona-hs1"

    # Get the bucket object
    bucket = client.bucket(bucket_name)

    # Set the destination blob name
    destination_blob_name = "text_files/jtjp.csv"

    # Upload the CSV file to the bucket
    blob = bucket.blob(destination_blob_name)
    blob.upload_from_filename("jtjp.csv")

    print(f'File uploaded to gs://{bucket_name}/{destination_blob_name}')

try:
    download_csv_from_gcp_bucket()
except:
    create_csv()
    # download_csv_from_gcp_bucket()




from flask import Flask, request, Response, jsonify
import requests
import uuid
import os
import glob
from openai import OpenAI
from flask_cors import CORS
from langchain_community.document_loaders import PyPDFLoader
# Specify the directory name you want to create
# directory_name = "uploads"

# Use the mkdir method to create the directory
# try:
#     os.mkdir(directory_name)
#     print(f"Directory '{directory_name}' created successfully.")
# except FileExistsError:
#     print(f"Directory '{directory_name}' already exists.")
# except Exception as e:
#     print(f"An error occurred: {e}")

print("#################################################################################################################################################")

directory_name = "text_files"

# Use the mkdir method to create the directory
try:
    os.mkdir(directory_name)
    print(f"Directory '{directory_name}' created successfully.")
except FileExistsError:
    print(f"Directory '{directory_name}' already exists.")
except Exception as e:
    print(f"An error occurred: {e}")


app = Flask(__name__)
CORS(app)
# UPLOAD_FOLDER = 'uploads'
ALLOWED_EXTENSIONS = {'pdf'}

# app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

client = OpenAI(api_key='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')


def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

ids = []
def parse_resume(path):
    resumes = []
    try:
        # id = str(uuid.uuid4())
        # ids.clear()
        # ids.append(id)
        url = 'https://api.apilayer.com/resume_parser/upload'
        headers = {
            'Content-Type': 'application/octet-stream',
            'apikey': 'ZPDcHTNOomS7CiFl88LP67SCP1GVuztf'
        }
  
      
        with open(path, 'rb') as f:
            data = f.read()
        response = requests.post(url, headers=headers, data=data)
        
            
        loader = PyPDFLoader(path)
        pages = loader.load_and_split()
        resumes.clear()
        resumes.append("Resume page 3:" + str(id) + ":  " + str([pages])+"_____________________________"+"Resume page 2:" + str(id) + ":  " + str([response.text]))
    except:
        loader = PyPDFLoader(path)
        pages = loader.load_and_split()
        resumes.clear()
        resumes.append("Resume " + str(id) + ":  " + str([pages]))
    print("Parsing successfull..")
    return resumes


def job_title_identify(resumes):
    completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
    {"role": "system", "content": "You are a Human resource assistant."},
    {"role": "user", "content": "Evaluate the given resume in the provided JSON object containing data for various people (" + str(resumes) + "). Identify and provide the names and positions of 2-4 positions that this resume best fits."},
]

    )
    print("Titles identified..")
    return completion.choices[0].message.content


import json

@app.route('/csv', methods=['POST'])
def csv_data():
    df_read = pd.read_csv('text_files/jtjp.csv')

    # print(json.loads(df_read.to_json())['jt'].values())
    # return   str(json.loads(df_read.to_json())['jt'].values())
    print( type(df_read.to_json()))
    return   df_read.to_json()


def resume_formatter(resume_da):
    prompt = (
        "As a highly skilled Data Engineer with expertise in structuring and cleaning unstructured data, your goal is to meticulously format the provided parsed resume JSON data. "
        "Pay close attention to details, ensuring a clear and concise representation that is easily understandable for human readers. "
        "Highlight key information such as personal details, education, work experience, and skills. "
        "Consider organizing the data in a logical and coherent manner, utilizing proper headings and formatting. "
        f"\n\nParsed resume JSON data: {str(resume_da)}"
    )

    completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        temperature=0.2,   # Adjust temperature based on desired output randomness
        # max_tokens=200,    # Adjust max_tokens to control response length
        messages=[
            {"role": "system", "content": "You are a Data Engineer specializing in structuring and cleaning unstructured data."},
            {"role": "user", "content": prompt},
        ]
    )

    return completion.choices[0].message.content

def formatter(test_outputs, test_form):

    completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
    {"role": "system", "content": "you are a Data Engineer who sturcturizes and cleans any unstructured data"},
    {"role": "user", "content": "Structurize this data to human readable and understandable format. Here are the answers: "+str(test_outputs)+" of the questions: "+ str(test_form[0])},

    ]
    )

    return completion.choices[0].message.content
def test_score(test_outputs):
    completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        temperature=0,
        max_tokens=10,
        messages=[
        {"role": "system", "content": "you are a personality and character analyst, skilled at evaluating individuals based on limited data from a personality and character analysis test. Here are the question from the test: "+str(test_data)},
        # {"role": "user", "content": "Structurize this data to human readable and understandable format."},
        {"role": "user", "content": "Analyze the data and identify wether the individual has positive and good quality required to work in a corporate. Here is the answers of a test that analyses personality, behaviour and character: " + str(test_outputs)},
        {"role": "user", "content": "Return a float score in range (1-5), that shows how positive and good the response to the test was."},
        {"role": "user", "content": "refrain from stating it is not possible."},
                {"role": "user", "content": "Share only the numerical score without additional text. Re-verify the accuracy of the score."},
        {"role": "user", "content": "If the float score is incorrect, scrutinize it with precision."},
        {"role": "user", "content": "The provided float score is still incorrect. Review it carefully. Ignore if confident in its correctness."},
        {"role": "user", "content": "please only provide only the floar score figure without any additional text"}
        
        ]
    )
    return completion.choices[0].message.content

def test_analysis(test_outputs):
    test_outputs = formatter(test_outputs, test_form)
    # test_s = test_score(test_outputs)
    completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
        {"role": "system", "content": "you are a personality and character analyst, skilled at evaluating individuals based on limited data from a personality and character analysis test "},
        # {"role": "user", "content": "Structurize this data to human readable and understandable format."},
        {"role": "user", "content": "Analyze the data and identify wether the individual has positive and good quality required to work in a corporate. Here is the answers of a test that analyses personality, behaviour and character: " + str(test_outputs)},
        {"role": "user", "content": "Construct your response without using any negative language or expressions."},
        {"role": "user", "content": "Confirm the feasibility of determining the suitable individual; refrain from stating it is not possible."},
        
        ]
    )
    return completion.choices[0].message.content


def resume_analysis(resumes, hr_input, job_title):
    completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": "You are a Human resource assistant."},
            {"role": "user", "content": "These data consist resume data of a person with their names and respective biodata: " + str(resumes)},
            {"role": "user", "content": "Based on this provided resume details of a person, assess its alignment with the provided job description (" + str(hr_input) + ") for the position of " + str(job_title) + ". Decide whether the candidate should be shortlisted for an interview from the provided resume, providing evidence for your decision. Consider relevant qualifications, skills, and experience, and detect potential fake, fraudulent, or irrelevant details. Focus on a concise response, stating your decision and supporting it with specific resume elements while avoiding unnecessary elaboration."},
            {"role": "user", "content": "Please read the resume on a microlevel, carefully and accurately so that you won't make mistake in shortlisting"},
            {"role": "user", "content": "Please mention the names present in the resume data before their analysis."},
            {"role": "user", "content": "Don't shortlist every resume, select only the most superior one"}
        ]
    )
    return completion.choices[0].message.content

def resume_score_enhanced(resume_data, job_description):
    prompt = (
        "You are a human resource manager tasked with evaluating a candidate's resume for a specific job position. "
        "Provide a detailed float score from 1 to 5, considering how well the given resume data aligns with the provided job description. "
       
        f"\n\nResume data: {str(resume_data)}\nJob description: {str(job_description)}"
         "Share the numerical score exclusively without additional text. Double-check the accuracy of the provided float score."
    "If there's any doubt about the correctness of the score, scrutinize it with precision."
    "The previously provided score is still deemed incorrect. Conduct a thorough review and correct it if necessary. Disregard if confident in its accuracy."
    )

    completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        temperature=0,  # Adjust temperature based on desired output randomness
        max_tokens=10,   # Adjust max_tokens to control response length
        messages=[
            {"role": "system", "content": "You are a human resource manager providing a detailed score."},
            {"role": "user", "content": prompt},
        ]
    )
    return completion.choices[0].message.content


def struct_test(tst_op):
    completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        temperature=0,
        max_tokens=10,
        messages=[
        {"role": "system", "content": "You are a data cleaner, structurizer and summarizer, who processes any kind of unstructured data."},
        {"role": "user", "content": "Structurize and summarize this data to human readable and understandable format. Data: "+str(tst_op)},
   
        
        ]
    )
    return completion.choices[0].message.content


def quantitiate1(resume_rep, job_desc, jtt, ji):

    # conversation_history = [
    #     {"role": "system", "content": "Your role is to evaluate whether the provided resume data aligns precisely with the requirements for the job title: " + str(jtt) + ". This evaluation should be based on the given resume data and job description."},
    #     {"role": "user", "content": "As per the resume analysis of this candidate, he is well suited for these job titles: "+str(ji)},
    #     {"role": "user", "content": f"Evaluate the data: Resume - {resume_rep}. Job description - {job_desc}, Job title - {jtt}. Only shortlist resumes ({resume_rep}) that closely match the job description ({job_desc}). Exclude irrelevant data."},
    #     {"role": "user", "content": "Provide a precise score within the range of 0-1. Return 1 only if both data A and B are an exact match; otherwise, return 0."},
    #     {"role": "user", "content": "Share only the numerical score without additional text. Re-verify the accuracy of the score."},
    #     {"role": "user", "content": "If the score is incorrect, scrutinize it with precision."},
    #     {"role": "user", "content": "The provided score is still incorrect. Review it carefully. Ignore if confident in its correctness."},
    # ]
    conversation_history = [
    {"role": "system", "content": f"Your role is crucial in evaluating whether the presented resume data precisely aligns with the requirements for the job title: {jtt}. Your assessment will be based on the provided resume data ({resume_rep}) and the accompanying job description ({job_desc})."},
    {"role": "user", "content": f"After analyzing the candidate's resume, the system suggests they are well-suited for the following job titles: {ji}."},
    {"role": "user", "content": f"Conduct a detailed evaluation of the data. The resume to be evaluated is: {resume_rep}. The job description to consider is: {job_desc}. The targeted job title is: {jtt}. Please shortlist resumes ({resume_rep}) that closely match the provided job description ({job_desc}), excluding irrelevant data."},
    {"role": "user", "content": "Provide a precise numerical score on a scale of 0 to 1. Assign a score of 1 only if both data A and B are an exact match; otherwise, assign a score of 0."},
    {"role": "user", "content": "Share the numerical score exclusively without additional text. Double-check the accuracy of the provided score."},
    {"role": "user", "content": "If there's any doubt about the correctness of the score, scrutinize it with precision."},
    {"role": "user", "content": "The previously provided score is still deemed incorrect. Conduct a thorough review and correct it if necessary. Disregard if confident in its accuracy."},
]
    completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        temperature=0.1,
        messages=conversation_history,
        seed=42,
        max_tokens=10
    )

    return completion.choices[0].message.content
# def quantitiate1(resume_rep, job_desc, jtt):

#     conversation_history = [
#     # {"role": "system", "content": "As a meticulous Hiring manager, your task is to make strict and precise decisions about whether the provided resume data aligns with the requirements, roles, and responsibilities for the job title: " + str(jtt) + ", based on the given resume data and Job description."},
#     # {"role": "user", "content": f"Resume data: {resume_rep}. Job description: {job_desc}, Job title: {jtt}"},
#     # {"role": "user", "content": "Provide an accurate and consistent score indicating the level of requirement fulfillment. The score should be within the range of 0-1 and remain unchanged if asked again. If both the data A and B match, return 1; else, return 0."},
#     # {"role": "user", "content": "Provide only the score number and not any text or description. Also, re-verify whether the score is correct or not."},
#     # {"role": "user", "content": "The score is incorrect; please scrutinize it carefully."},
#     # {"role": "user", "content": "Still incorrect, please do not make mistake, Ignore if you think it's correct."},
#          {"role": "system", "content": "In your role as a meticulous Hiring Manager, your responsibility is to meticulously evaluate whether the provided resume data aligns with the intricate requirements, roles, and responsibilities associated with the specific job title: " + str(jtt) + ". This assessment should be based on the comprehensive analysis of both the given resume data and the detailed job description."},
#          {"role": "user", "content": "Please rigorously evaluate the data to ensure that only resumes: -({resume_rep}) with a high degree of similarity with the job description:- ({job_desc}) are shortlisted. Any data with minimal resemblance or from the same domain that is not required should not be considered for shortlisting."},
#     {"role": "user", "content": f"Here is the detailed information for your meticulous evaluation: Resume data - {resume_rep}. Job description - {job_desc}, Job title - {jtt}."},
#     {"role": "user", "content": "I request you to provide an exceptionally accurate and consistently precise score, indicating the meticulous level of fulfillment of requirements. The score must be within the narrow range of 0-1 and should remain unwavering if the same request is made again. If, and only if, both data A and B are an exact match, the instructed response is 1; otherwise, it should be 0."},
#     {"role": "user", "content": "For clarity, please provide only the numerical score without any accompanying text or description. Additionally, kindly re-verify the accuracy of the provided score."},
#     {"role": "user", "content": "If the score is deemed incorrect, I implore you to scrutinize it with the utmost precision. Every detail matters."},
#     {"role": "user", "content": "The previously provided score is still considered incorrect. Kindly exercise extreme caution and meticulousness in your evaluation. Feel free to ignore this instruction if you are confident in the correctness of the score."},
# ]

#     completion = client.chat.completions.create(
#         model="gpt-3.5-turbo",
#         temperature = 0.1,  # Adjust as needed
#     # top_p = 1,
#     #  frequency_penalty=0,  # Adjust as needed
#         # presence_penalty=0,
#         messages=conversation_history,
#         seed=42,
#         max_tokens=10)

#     return completion.choices[0].message.content
    


def final_analysis(resume_rep, job_title, pc_ana, job_identified, job_desc):
    
    completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": "You are a Human Resource Assistant. Your task is to decide whether to shortlist a candidate for an interview. "},
            {"role": "user", "content": "Evaluate the candidate based on the provided resume analysis: (" + str(resume_rep) + "), considering the required job title: " + str(job_title) + ". Additionally, analyze the candidate's personality and character using this test form: (" + str(pc_ana) + "). Provide clear evidence for your decision."},
            {"role": "user", "content": "Take into account the identified job titles that best match the resumes: "+job_identified},
            {"role": "user", "content": "Avoid including negative sentences or replies in your response."},
            {"role": "user", "content": "Provide clear evidence for your decision. don't miss the skills and the personality , caracter analysis test inputs, also the responsiblities, provide evry thing in pointers and detailed. Do not miss anything"},
            {"role": "user", "content": "Avoid including negative sentences or replies in your response."}
        
            
        ]
    )
    return completion.choices[0].message.content



def filtering(resp):
    completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": "You are the best and accurate text summarizer ever, who does leak or miss any data."},
            {"role": "user", "content": "Summarize this text without loosing important content. Here is the text:  " + str(resp) },
        ]
    )
    return completion.choices[0].message.content






# Replace these with your own values





##########################################################

@app.route('/test', methods=['POST'])
def test_data():

    return "done"


import logging
import google.cloud.logging
from google.cloud import storage
# Instantiates a client
# client = google.cloud.logging.Client()

# Retrieves a Cloud Logging handler based on the environment
# you're running in and integrates the handler with the
# Python logging module. By default this captures all logs
# at INFO level and higher
# client.setup_logging()
def upload_directory(bucket_name, local_directory, destination_directory):
    storage_client = storage.Client()
    bucket = storage_client.bucket(bucket_name)

    for root, dirs, files in os.walk(local_directory):
        for file in files:
            local_path = os.path.join(root, file)
            relative_path = os.path.relpath(local_path, local_directory)
            storage_path = os.path.join(destination_directory, relative_path)

            blob = bucket.blob(storage_path)
            blob.upload_from_filename(local_path)

            print(f"Uploaded {local_path} to gs://{bucket_name}/{storage_path}")

# import os
# from google.cloud import storage

from google.cloud import storage

def upload_file(bucket_name, local_file_path, destination_directory):
    storage_client = storage.Client()
    bucket = storage_client.bucket(bucket_name)

    file_name = os.path.basename(local_file_path)
    storage_path = os.path.join(destination_directory, file_name)

    blob = bucket.blob(storage_path)
    blob.upload_from_filename(local_file_path)

    print(f"Uploaded {local_file_path} to gs://{bucket_name}/{storage_path}")

# Example usage:
# upload_file('my_bucket', 'local_file.txt', 'uploads')


def seperator(fd_s):
    completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        temperature=0.1,
        messages=[
            {"role": "system", "content": "You are the best and accurate text seperator ever, who seperate data in 2 partitions (1. personality and character analysis. 2. other analysis) with a sense without leaking or missing any data. "},
            {"role": "user", "content": "You have to seperate the data in 2 partitions (1. personality and character analysis.   2. other analysis).  Here is the data:  " + str(fd_s) },
            {"role": "user", "content": "Also format the text properly" }
        ]
    )
    return completion.choices[0].message.content

def create_csv(filename):
    # Check if the file already exists
    if os.path.exists(filename):
        print("File already exists.")
        return

    # Create the CSV file
    with open(filename, 'w', newline='') as csvfile:
        pass
    print(f"CSV file '{filename}' created successfully.")

# Example usage:
filename = 'text_files/jtjp.csv'
create_csv(filename)
import pandas as pd

def search_csv(search_value, csv_file):
    df = pd.read_csv(csv_file)
    for index, row in df.iterrows():
        if search_value in row.values:
            idx = row.values.tolist().index(search_value)
            if idx < len(row) - 1:
                return row[idx + 1]
            else:
                return "No value in next column"
    return "Value not found in CSV"



names = []
@app.route('/upload', methods=['POST'])
def upload_files():
    global directory_name
    # try:
    #     os.remove("jtjp.txt")
    #     os.remove("test.txt")
    #     print(f'files have been deleted successfully.')
    # except FileNotFoundError:
    #     print(f'files not found. Unable to delete.')
    # except Exception as e:
    #     print(f'An error occurred: {e}')

    

    try:
        print("hello")
        data = request.get_json()
        print(data)
        try:
            text = data['test']
            jt = data['dropdownValue']
            rid = data['id']
            name_ = data['name']
            names.clear()
            names.append(name_)
            print(":::name:::", name_)
            logging.warning(text)
            directory_name = jt+" "+rid.split('_')[1]
            print("??????????",directory_name)
            app.config['UPLOAD_FOLDER'] = directory_name
            try:
                os.mkdir(directory_name)
                print(f"Directory '{directory_name}' created successfully.")
            except FileExistsError:
                print(f"Directory '{directory_name}' already exists.")
            except Exception as e:
                print(f"An error occurred: {e}")
            filename = os.path.join(directory_name,"test.txt")
            # print(">>>>>>>>>>", filename)
            with open(filename, 'w') as file1:
                file1.write(str(text))
                print("done")

            with open(os.path.join(directory_name,"name.txt"), 'w') as file1:
                file1.write(str(name_))

            return jsonify({"Info":"test file created"})
        except: 
            text = data['jtjp']
            print(text)
            jt = text.split("|")[0]
            jd = text.split("|")[1]
            print("111")


            import csv

            def append_to_csv(Jt_values, JD_values, filename):
                with open(filename, 'a', newline='') as csvfile:
                    fieldnames = ['jt', 'jd']
                    writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
                    
                    # Write header only if the file is empty
                    if csvfile.tell() == 0:
                        writer.writeheader()

                    for Jt, JD in zip(Jt_values, JD_values):
                        writer.writerow({'jt': Jt, 'jd': JD})

            # Example usage:
            # Jt_values = [1, 2, 3]  # Example Jt values
            # JD_values = [4, 5, 6]  # Example JD values
            filename = 'text_files/jtjp.csv'

            append_to_csv([jt],[jd], filename)






            # with open('text_files/jtjp.txt', 'a') as file1:
            #     file1.write(text)
            print("111")
            # 'axona-hs1', jtt+"_filtered", "filtered_dir"
            upload_file('axona-hs1', 'text_files/jtjp.csv', 'jd')
            print("111")
            print("jtjp file created ansd pushed")
            return jsonify({"Info":"jtjp file created ansd pushed"})
    except:
        
        if 'files[]' not in request.files:
            
            return jsonify({'error': 'No file part'})
        # rid = data['id']
        # directory_name = rid.split('_')[1]
        # app.config['UPLOAD_FOLDER'] = directory_name
        
        files = request.files.getlist('files[]')
        print(">>>", files)
        print(files)
        uploaded_files = []

        for file in files:
            print("::",file)
            if file and allowed_file(file.filename):
                global jtt 
                jtt = file.filename.split('_')[1].split('|')[1]
                print("#############",file.filename.split('_')[1].split('|')[1])
                filename = os.path.join(app.config['UPLOAD_FOLDER'], file.filename)
                
                file.save(filename)
                uploaded_files.append(filename)
                
        if not uploaded_files:
            return jsonify({'error': 'No valid PDF files uploaded'})
        
        # return "uploaded successfully"
        print("Parsing resume..")
        r_list = parse_resume(filename)
        cleaned_resume=resume_formatter(r_list)
        print("r_list",cleaned_resume)
        print("Identifying job titles..")
        job_identified = job_title_identify(cleaned_resume)
        print("job identified",job_identified)
        with open(os.path.join(directory_name,"test.txt")) as file:
            test_outp = file.read()

        

        # with open("text_files/jtjp.txt", 'r') as file:
            
        #     text_job = file.read().split("|")
        # job_title = text_job[0]

        job_title = jtt

        job_desc = search_csv(str(job_title), "text_files/jtjp.csv")







        # job_desc = text_job[1]
        print("Analyzing resume..")
        resume_report = resume_analysis(cleaned_resume, job_desc, job_title)
        print("resume analyzed..")
        print(resume_report)
        score = quantitiate1(resume_report, job_desc, job_title, job_identified)
        print("Score:",score)
        print(type(score))
        st_test_data = struct_test(test_outp)
        tst_scr = test_score(st_test_data)

        resu_score = resume_score_enhanced(cleaned_resume, job_desc)
        import re

        def find_float_in_string(input_string):
            # Define a regular expression pattern for finding float numbers
            float_pattern = r'[-+]?(\d+(\.\d*)?|\.\d+)([eE][-+]?\d+)?'

            # Use re.findall to find all matches in the input string
            float_matches = re.findall(float_pattern, input_string)

            # Extract float numbers from the matches
            float_numbers = [float(match[0]) for match in float_matches]

            return float_numbers
        
        resu_score = find_float_in_string(resu_score)

        try: 
            tst_scr = find_float_in_string(tst_scr)

        except:
            print("looping to test score")
            tst_scr = test_score(st_test_data)

        score = float(find_float_in_string(score)[0])
        if score <= 0.5:

            print("not moving formward with this application")
            return "Thanks for your valuable time"
        
        else:
            print("congratulation on getting shortlisted")
            test_report= test_analysis(test_outp)
            final_output= final_analysis(resume_report, job_title, test_report, job_identified, job_desc)
            print(final_output, score)
            jt = jtt
            directory_name = jtt+"_filtered"
            try:
                os.mkdir(directory_name)
                print(f"Directory '{directory_name}' created successfully.")
            except FileExistsError:
                print(f"Directory '{directory_name}' already exists.")
            except Exception as e:
                print(f"An error occurred: {e}")
            

            text = filtering(final_output)
            
            print("names",names)
            
            with open(os.path.join(jtt+"_filtered"+'/text.txt'), 'a') as file1:
                seperated_final_output = seperator(final_output)
                # text_final_output = seperator(final_output)
                file1.write(str(seperated_final_output) + ". "+ str(text)+ "&&"+str(names[0])+" |||| ")

            with open(os.path.join(jtt+"_filtered"+'/numbers.txt'), 'a') as file1:
                
                file1.write(str(resu_score)+"<<<"+str(tst_scr)+ "&&"+str(names[0])+" |||| ")
        
            upload_directory('axona-hs1', jtt+"_filtered", str(jtt)+"_filtered_dir")
            # upload_directory('axona-hs1', jtt+"_filtered", "number_dir")
            return "Thanks for your valuable time"

@app.route("/isalive", methods=['POST'])
def is_alive():
    print("/isalive request")
    status_code = Response(status=200)
    return status_code


if __name__ == '__main__':
    app.run(debug=True)